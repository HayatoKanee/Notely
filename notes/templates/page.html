{% extends 'base_content_without_footer.html' %}
{% block content %}
    {% if page.notebook.folder %}
     <a href={% url 'sub_folders_tab' page.notebook.folder.id %} style="color:#1b1b1b;margin-left:20px"> <i class="bi bi-arrow-left" style="color: rgb(245, 93, 66);"></i> Go back</a>
    {% else %}
         <a href={% url 'folders_tab'%} style="color:rgb(245,93,66);margin-left:20px;font-size:20px;"> <i class="bi bi-arrow-left"></i> Go back</a>
    {% endif %}
    <button style="color: rgb(245, 93, 66)" onclick="startTour();">Start Tour</button>
    <canvas id="canvas"></canvas>
    <nav class="navbar navbar-expand-lg fixed-bottom navbar-light bg-light">
    <div class="container-fluid">
        <ul class="navbar-nav mx-auto mt-2 mt-lg-0">
        <li class="nav-item">
            <button class="toolbox" id="clearAll" onclick="clearCanvas(canvas)" style="color: rgb(245, 93, 66);"></button>
        </li>
        <li class="nav-item">
            <button class="toolbox" id="undo" onclick="undo(this)" style="color: rgb(245, 93, 66);"></button>
        </li>
        <li class="nav-item">
            <button class="toolbox" id="redo" onclick="redo(this)" style="color: rgb(245, 93, 66);"></button>
        </li>
        <li class="nav-item">
            <button class="toolbox" id="select" onclick="toggleSelect(this)"></button>
         </li>
        <div class="accordion accordion-flush" id="accordionFlush">
            <div class="accordion-item">
                <li class="accordion-header" id="flush-headingPen">
                    <li class="nav-item">
                    <button class="toolbox" id="draw" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsePen"
                            aria-expanded="false" aria-controls="flush-collapsePen" onclick="toggleDraw(this)"></button>
                    </li>
                </li>
                <div id="flush-collapsePen" class="accordion-collapse collapse" aria-labelledby="flush-headingPen" data-bs-parent="#accordionFlush">
                    <li class="nav-item">
                        <div style="min-height: 120px;">
                            <div class="card card-body" style="width: 300px;">
                                <label>Pen Mode</label>
                                <select id="chooseMode" style="color: rgb(245, 93, 66);">
                                    <option value="circle">Circle Brush</option>
                                    <option value="crayon">Crayon</option>
                                    <option value="ink">Ink Pen</option>
                                    <option value="fur">Fur Brush</option>
                                    <option value="longfur">Long Fur Brush</option>
                                    <option value="marker">Marker</option>
                                    <option value="ribbon">Ribbon Brush</option>
                                    <option value="shaded">Shaded Brush</option>
                                    <option value="sketchy">Sketchy Brush</option>
                                    <option value="spraypaint">Spray Paint</option>
                                    <option value="square">Square brush</option>
                                    <option value="web">Web Brush</option>
                                </select>
                                <label>Pen Colour</label>
                                <input id='choosePenColor' value="#000000" data-jscolor="" style="color: rgb(245, 93, 66);">
                                <label>Pen Width</label>
                                <input id='chooseWidth' value='1' type=range min='1' max='20'>
                        </div>
                        </div>
                    </li>
                </div>
            </div>
            <div class="accordion-item">
                <li class="accordion-header" id="flush-headingText">
                    <li class="nav-item">
                        <button class="toolbox" id="text" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseText" aria-expanded="false"
                                aria-controls="flush-collapseText" onclick="toggleText(this)" style="color: rgb(245, 93, 66);">
                        </button>
                    </li>
                </li>
                <div id="flush-collapseText" class="accordion-collapse collapse" aria-labelledby="flush-headingText" data-bs-parent="#accordionFlush">
                    <li class="nav-item">
                        <div style="min-height: 120px;">
                            <div class="card card-body" style="width: 300px; color: rgb(245, 93, 66);">
                                <label>Text Colour</label>
                                <input id='chooseTextColor' value="#000000" data-jscolor="" style="color: rgb(245, 93, 66);">
                            </div>
                        </div>
                    </li>
                </div>
            </div>

        </div>
        <li class="nav-item">
         <button class="toolbox" id="erase" type="button" onclick="toggleErase(this)" style="color: rgb(245, 93, 66);">
         </button>
        </li>
        <li class="nav-item">
            <button class="toolbox" id="upload" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpload" aria-expanded="false"
                    aria-controls="collapseUpload" style="color: rgb(245, 93, 66);"></button>
        </li>
        <li class="nav-item">
            <div style="min-height: 120px;">
                <div class="collapse collapse-horizontal" id="collapseUpload" style="color: rgb(245, 93, 66);">
                <div class="card card-body" style="width: 300px; color: rgb(245, 93, 66);">
                    <input id="img" class="toolbox" type="file" accept="image/*">
                </div>
                </div>
            </div>
        </li>
        <li class="nav-item">
            <button class="toolbox" id="table" type="button"></button>
                <div id="tableModal" class="modal">
                <div class="modal-content">
                <span class="close">&times;</span>
                <form>
                    <label for="rows">Rows:</label>
                    <input type="number" id="rows" name="rows" value="2" min="1"><br><br>
                    <label for="columns">Columns:</label>
                    <input type="number" id="columns" name="columns" value="2" min="1"><br><br>
                    <input type="button" value="Submit" id="submitTable">
                </form>
                </div>
                </div>
            </li>
            <li class="nav-item">
                <button class="toolbox" id="showCodeEditor"  data-bs-toggle="modal" data-bs-target="#codeEditor" style="color: rgb(245, 93, 66);"></button>
            </li>
            <li class="nav-item">
                <button class="toolbox" id="showSymbols"  data-bs-toggle="modal" data-bs-target="#symbols" style="color: rgb(245, 93, 66);"></button>
            </li>
            <li class="nav-item">
                <button class="toolbox" id="linkPage"  data-bs-toggle="offcanvas" href="#sidebar" aria-controls="sidebar" style="color: rgb(245, 93, 66);"> Link Page</button>
            </li>
            <li class="nav-item">
                <button class="toolbox" id="download" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDownload" aria-expanded="false"
                        aria-controls="collapseDownload" style="color: rgb(245, 93, 66);"></button>
            </li>
            <li class="nav-item">
                <div style="min-height: 120px;">
                    <div class="collapse collapse-horizontal" id="collapseDownload" style="color: rgb(245, 93, 66);">
                    <div class="card card-body" style="width: 300px; color: rgb(245, 93, 66);">
                        <button id="downloadAsPic" type="button" >Download as PNG</button>
                    </div>
                    </div>
                </div>
            </li>
    </ul>
        </div>
    </nav>
    {% include 'partials/codeEditor.html' %}
    {% include 'partials/symbols.html' %}
{% endblock %}
{% block scripts %}
    {% load static %}
    <script src="{%static 'javascript/note-taking/fabric.min.js'%}"></script>
    <script>
    const page_id = "{{ page.id }}";
    const drawing = '{{ page.drawing|safe}}';
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrf = getCookie('csrftoken');
    </script>
    <script>
        $(document).click(function(e) {
            if ($("#draw").is(e.target)) {
                sessionStorage.setItem("currentTool", "draw");
            }

            if ($("#text").is(e.target)) {
                sessionStorage.setItem("currentTool", "text");
            }

            if (!$("#draw").is(e.target) && !$("#draw").has(e.target).length) {
                if ($("#draw").attr("aria-expanded") == 'true') {
                    document.querySelector('#draw').click();
                }
            }

            if (!$("#text").is(e.target) && !$("#text").has(e.target).length) {
                if ($("#text").attr("aria-expanded") == 'true') {
                    document.querySelector('#text').click();
                }
            }

            if ($("#undo").is(e.target)) {
                if (sessionStorage.getItem("currentTool") == 'draw') {
                    document.querySelector('#draw').click();
                } else if (sessionStorage.getItem("currentTool") == 'text') {
                    document.querySelector('#text').click();
                }
            }

            if ($("#redo").is(e.target)) {
                if (sessionStorage.getItem("currentTool") == 'draw') {
                    document.querySelector('#draw').click();
                } else if (sessionStorage.getItem("currentTool") == 'text') {
                    document.querySelector('#text').click();
                }
            }

        });
    </script>
    <script>
    const tour = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
            exitOnEsc: true
        }
    });

    tour.addStep({
        id: 'begin',
        text: "Welcome to the tutorial, this will help you to understand features in Notely's pages. Press Esc at any time to quit this tutorial",
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        buttons: [
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'clearAll',
        text: 'This button clears the whole page.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#clearAll',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'undo',
        text: 'This button undo the page.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#undo',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'redo',
        text: 'This button redo the page.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#redo',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'select',
        text: 'This button gives mouse the ability to select all included inputs.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#select',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'draw',
        text: 'This button gives the mouse the ability to draw on the canvas.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#draw',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'text',
        text: 'This button gives the mouse the ability to create a text field.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#text',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'erase',
        text: 'This button gives mouse the ability to erase pixels.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#erase',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'upload',
        text: 'This button imports a selected image into the canvas.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#upload',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'table',
        text: 'This button insert a table into the canvas.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#table',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'showCodeEditor',
        text: 'This button creates a code editor on the canvas.',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#showCodeEditor',
            on: 'top'
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],

    });

    tour.addStep({
        id: 'codeEditor',
        text: 'Features about the Code Editor... To be continue',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: '#codeEditor > div:nth-child(1) > div:nth-child(1) > div:nth-child(1) > h1:nth-child(1)',
            on: 'top'
        },
        beforeShowPromise: function() {
            return new Promise(function(resolve) {
                document.querySelector('#showCodeEditor').click();
                resolve();
            });
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Next',
                 action: tour.next
            }
        ],
    });

    tour.addStep({
        id: 'tutorial',
        text: 'That is the end of the tutorial, if you want to watch it again please click this button',
        scrollTo: {
            behavior: 'smooth',
            block: 'center'
        },
        attachTo: {
            element: 'body > button:nth-child(5)',
            on: 'bottom'
        },
        beforeShowPromise: function() {
            return new Promise(function(resolve) {
                document.querySelector('#codeEditor > div:nth-child(1) > div:nth-child(1) > div:nth-child(1) > button:nth-child(2)').click();
                resolve();
            });
        },
        buttons: [
            {
                 text: 'Back',
                 action: tour.back
            },
            {
                 text: 'Done',
                 action: tour.next
            }
        ],
    });


    if (localStorage.getItem("seen_tour") == null) {
        tour.start();
        localStorage.setItem("seen_tour", "true");
    }

    function startTour(){
        tour.start();
    }

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
        <script src="{%static 'javascript/note-taking/draw.js'%}"></script>
        <script src="{%static 'javascript/note-taking/jscolor.js'%}"></script>
        <script src="{%static 'javascript/note-taking/codemirror.js'%}"></script>
        <link rel="stylesheet" href="{%static 'css_style/codemirror.css'%}">
        <script src="{%static 'javascript/mode/python.js'%}"></script>
        <script src="{%static 'javascript/mode/javascript.js'%}"></script>
        <script src="{%static 'javascript/mode/django.js'%}"></script>

        <script src="{% static 'javascript/download.js'%}"></script>
        <script src="{% static 'javascript/fileSaver.min.js'%}"></script>
        <script src="{% static 'javascript/canvas-toBlob.js'%}"></script>
        <script src="{%static 'javascript/note-taking/codeEditor.js'%}"></script>
        <script src="{%static 'javascript/note-taking/symbols.js'%}"></script>
        <script src="{% static 'javascript/note-taking/linkPage.js'%}"></script>
        <script src="{% static 'javascript/note-taking/table.js'%}"></script>
        <script src="{%static 'javascript/note-taking/fabric.brushes.min.js'%}"></script>



{% endblock %}
